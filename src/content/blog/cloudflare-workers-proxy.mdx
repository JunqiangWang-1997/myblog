---
title: "cloudflare workers åä»£embyæ•™ç¨‹"
description: "æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢"
pubDate: 2026-02-15
tags: ["éšç¬”"]
heroImage: '../../assets/blog-placeholder-1.jpg'
---
import CodeBlock from '../../components/CodeBlock.astro';
import img1 from '../../assets/cloudflare-workers-proxy/1.png';
import img2 from '../../assets/cloudflare-workers-proxy/2.1.png';
import img3 from '../../assets/cloudflare-workers-proxy/2.2.png';
import img4 from '../../assets/cloudflare-workers-proxy/3.1.png';
import img5 from '../../assets/cloudflare-workers-proxy/3.2.png';

Cloudflare Workers æ˜¯ Cloudflare æä¾›çš„ä¸€ç§æ— æœåŠ¡å™¨è®¡ç®—å¹³å°ï¼Œå…è®¸å¼€å‘è€…åœ¨ Cloudflare çš„è¾¹ç¼˜ç½‘ç»œä¸Šè¿è¡Œ JavaScript ä»£ç ã€‚é€šè¿‡ä½¿ç”¨ Workersï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°å®ç°åå‘ä»£ç†åŠŸèƒ½ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å…¶ä»–æœåŠ¡å™¨æˆ–æœåŠ¡ã€‚ä»¥ä¸‹å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cloudflare Workers å®ç°embyçš„åå‘ä»£ç†åŠŸèƒ½å¹¶ä¼˜é€‰åŸŸåã€‚
ä¸€å…±åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥æ˜¯å‡†å¤‡å·¥ä½œï¼Œç¬¬äºŒæ­¥æ˜¯å®ç°cloudflare workersåä»£åŠŸèƒ½ï¼Œç¬¬ä¸‰æ­¥æ˜¯ä¼˜é€‰åŸŸå
# ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ
åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ‚¨éœ€è¦å‡†å¤‡ä»¥ä¸‹å†…å®¹ï¼š
1. **Cloudflare è´¦æˆ·**ï¼šå¦‚æœæ‚¨è¿˜æ²¡æœ‰ Cloudflare è´¦æˆ·ï¼Œè¯·å‰å¾€ [Cloudflare å®˜ç½‘](https://www.cloudflare.com/) æ³¨å†Œä¸€ä¸ªå…è´¹è´¦æˆ·ã€‚
2. **åŸŸå**ï¼šæ‚¨éœ€è¦ä¸€ä¸ªåŸŸåæ¥é…ç½® Cloudflare Workers çš„è·¯ç”±ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç°æœ‰çš„åŸŸåï¼Œæˆ–è€…ç”³è¯·ä¸€ä¸ªå…è´¹çš„å­åŸŸåï¼šä¾‹å¦‚åœ¨ https://indevs.in/ ä¸Šï¼ŒæŒ‰ç…§æŒ‡å¼•æ³¨å†Œå¹¶è·å–ä¸€ä¸ªå…è´¹çš„å­åŸŸåå¹¶æ‰˜ç®¡åˆ° Cloudflareã€‚å¦‚å›¾æ‰€ç¤ºå°†DNS NS é…ç½®ä¸º Cloudflare æä¾›çš„ NS æœåŠ¡å™¨ï¼š
<img src={img1.src} alt="å›¾1" />
# ç¬¬äºŒæ­¥ï¼šå®ç° Cloudflare Workers åä»£åŠŸèƒ½
## åˆ›å»º Cloudflare Worker
1. ç™»å½• Cloudflare è´¦æˆ·å¹¶è¿›å…¥ Workers é¡µé¢ã€‚
2. ç‚¹å‡» "åˆ›å»ºåº”ç”¨ç¨‹åº" æŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Workerï¼Œé€‰æ‹©ä»hello worldæ¨¡æ¿å¼€å§‹,ç‚¹å‡»éƒ¨ç½²ã€‚
<img src={img2.src} alt="å›¾2" />
3. ç„¶åé€‰æ‹©å·²ç»éƒ¨ç½²çš„ Workerï¼Œç‚¹å‡»ç¼–è¾‘ä»£ç ï¼Œæ›¿æ¢é»˜è®¤ä»£ç ä¸ºä»¥ä¸‹åå‘ä»£ç†ä»£ç å¹¶ä¿å­˜ï¼š
<CodeBlock title="Worker åä»£ä»£ç ï¼ˆç‚¹å¼€å¤åˆ¶ï¼‰" collapsed={true}>
```js
export default {
  async fetch(request, env, ctx) {
    // ================= é…ç½®åŒºåŸŸ =================

    // [ä¿®æ”¹è¿™é‡Œ] è¯·å¡«å…¥ emby çš„å®é™…å›æºåœ°å€
    const upstream_domain = 'www.example.com'; // ä¾‹å¦‚ï¼šemby.yourdomain.com
    const upstream_port = '443';        // é€šå¸¸æ˜¯ 443
    const upstream_protocol = 'https';   // é€šå¸¸æ˜¯ https

    // ===========================================

    const url = new URL(request.url);
    const worker_domain = url.host;

    // è·å–å®¢æˆ·ç«¯ä¿¡æ¯
    const clientIP = request.headers.get('CF-Connecting-IP') || 'Unknown';
    const country = request.cf ? request.cf.country : 'XX';
    const requestId = request.headers.get('cf-ray') || '-';
    const userAgent = request.headers.get('User-Agent') || '';

    // -----------------------------------------------------------
    // 0. å¼ºåˆ¶ HTTPS è·³è½¬
    // -----------------------------------------------------------
    if (url.protocol === 'http:') {
      url.protocol = 'https:';
      return Response.redirect(url.href, 301);
    }

    // -----------------------------------------------------------
    // 1. æ¶æ„ User-Agent å¿«é€Ÿæ‹¦æˆª
    // -----------------------------------------------------------
    const bad_agents = ['python', 'curl', 'wget', 'http-client', 'scrapy', 'java/', 'go-http'];
    if (bad_agents.some(agent => userAgent.toLowerCase().includes(agent))) {
      return new Response("403 Forbidden: Bot detected", { status: 403 });
    }

    // -----------------------------------------------------------
    // 2. æ‹¦æˆª robots.txt
    // -----------------------------------------------------------
    if (url.pathname === '/robots.txt') {
      return new Response("User-agent: *\nDisallow: /", {
        status: 200,
        headers: {
          'Content-Type': 'text/plain; charset=utf-8',
          'Cache-Control': 'public, max-age=86400'
        }
      });
    }

    // -----------------------------------------------------------
    // 3. åœ°åŒºæ£€æµ‹ï¼šä»…å…è®¸ä¸­å›½å¤§é™† IPï¼ˆä¿ç•™ä½ åŸé€»è¾‘ï¼‰
    // -----------------------------------------------------------
    if (country !== 'CN' && country !== 'XX') {
      const geoHtml = `
      <!DOCTYPE html>
      <html lang="zh-CN">
      <head><meta charset="UTF-8"><title>403 Access Denied</title></head>
      <body style="display:flex;justify-content:center;align-items:center;height:100vh;background:#f5f6f7;font-family:sans-serif;text-align:center;">
        <div style="background:white;padding:2rem;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.05);max-width:400px;border-top:5px solid #ff4757;">
          <h1 style="color:#2d3436;font-size:1.5rem;">ğŸš« è®¿é—®è¢«æ‹’ç»</h1>
          <p style="color:#636e72;">æœ¬æœåŠ¡ä»…é™ä¸­å›½å¤§é™†åœ°åŒºç›´è¿è®¿é—®ã€‚</p>
          <div style="background:#f1f2f6;padding:1rem;border-radius:8px;font-family:monospace;text-align:left;font-size:0.9rem;">
            <div>IP: ${clientIP}</div>
            <div>Loc: ${country}</div>
            <div>Ray: ${requestId}</div>
          </div>
        </div>
      </body>
      </html>`;

      return new Response(geoHtml, {
        status: 403,
        headers: {
          'Content-Type': 'text/html; charset=utf-8',
          'Cache-Control': 'public, max-age=3600'
        }
      });
    }

    // -----------------------------------------------------------
    // 4. è·¯å¾„æ£€æµ‹ï¼šä»…å…è®¸ /emby å¼€å¤´
    // -----------------------------------------------------------
    if (!url.pathname.startsWith('/emby')) {
      const guideHtml = `
      <!DOCTYPE html>
      <html lang="zh-CN">
      <head><meta charset="UTF-8"><title>Emby Gateway</title></head>
      <body style="display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);font-family:sans-serif;">
        <div style="background:rgba(255,255,255,0.95);padding:2.5rem;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.1);max-width:420px;">
          <div style="font-size:3rem;margin-bottom:1rem;">ğŸš€</div>
          <h1 style="color:#0984e3;margin:0 0 0.5rem 0;">OkEmby åŠ é€Ÿç½‘å…³</h1>
          <p style="color:#636e72;margin:0 0 1.2rem 0;">è¯·åœ¨å®¢æˆ·ç«¯ (Yamby / Fileball / VidHub) ä¸­ä½¿ç”¨æœ¬åœ°å€ã€‚</p>
          <div style="background:#f1f2f6;padding:1rem;border-radius:8px;text-align:left;font-family:monospace;">
            <div>Client IP: ${clientIP}</div>
            <div>Location: ${country}</div>
            <div>Status: <span style="color:#00b894">â— Online</span></div>
            <div>Ray: ${requestId}</div>
          </div>
        </div>
      </body>
      </html>`;

      return new Response(guideHtml, {
        status: 200,
        headers: {
          'Content-Type': 'text/html; charset=utf-8',
          'Cache-Control': 'public, max-age=3600'
        }
      });
    }

    // -----------------------------------------------------------
    // 5. OPTIONS é¢„æ£€
    // -----------------------------------------------------------
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        status: 204,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': request.headers.get('Access-Control-Request-Headers') || '*',
          'Access-Control-Max-Age': '86400'
        }
      });
    }

    // ===========================================================
    // 6. æ’­æ”¾è¿›åº¦ä¸ŠæŠ¥èŠ‚æµï¼ˆä¿®å¤ï¼šCache key å¿…é¡» GET/HEADï¼‰
    // ===========================================================
    const is_progress_report = url.pathname.includes('/Sessions/Playing/Progress');
    const cache = caches.default;

    // âš ï¸ key å¿…é¡»æ˜¯ GET/HEADï¼Œå¦åˆ™ cache.put ä¼šæŠ¥ï¼šCannot cache response to non-GET request.
    const lockKey = new Request(`${url.origin}${url.pathname}|ip=${clientIP}`, { method: 'GET' });

    if (is_progress_report && request.method === 'POST') {
      const cachedResponse = await cache.match(lockKey);
      if (cachedResponse) return new Response(null, { status: 204 });
    }

    // -----------------------------------------------------------
    // 7. å‡†å¤‡å›æºè¯·æ±‚
    // -----------------------------------------------------------
    url.host = upstream_domain;
    url.port = upstream_port;
    url.protocol = upstream_protocol + ':';

    const new_headers = new Headers(request.headers);
    new_headers.set('Host', upstream_domain);

    if (clientIP && clientIP !== 'Unknown') {
      new_headers.set('X-Forwarded-For', clientIP);
      new_headers.set('X-Real-IP', clientIP);
    }

    // WebSocket é€ä¼ ï¼ˆæ›´ç¨³ï¼šä¸ä¼  bodyï¼‰
    if ((request.headers.get('Upgrade') || '').toLowerCase() === 'websocket') {
      return fetch(new Request(url, { method: request.method, headers: new_headers }));
    }

    // -----------------------------------------------------------
    // 8. ç¼“å­˜åˆ¤æ–­é€»è¾‘ï¼ˆä¿®å¤ï¼šé™æ€ç¼“å­˜ä½¿ç”¨å›ºå®š GET keyï¼›æ”¯æŒ HEAD å‘½ä¸­ï¼‰
    // -----------------------------------------------------------
    const cache_extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.css', '.js', '.woff', '.woff2'];
    const has_static_ext = cache_extensions.some(ext => url.pathname.toLowerCase().endsWith(ext));
    const is_emby_image = /\/emby\/Items\/.*?\/Images\//i.test(url.pathname);
    const is_emby_ping = url.pathname.includes('/System/Ping');

    const is_cacheable_method = (request.method === 'GET' || request.method === 'HEAD');
    const should_cache = (has_static_ext || is_emby_image || is_emby_ping) && is_cacheable_method;

    // é™æ€ç¼“å­˜ key å›ºå®šç”¨å…¥å£ URL çš„ GETï¼ˆè¯»å†™ä¸€è‡´ï¼Œå‘½ä¸­ç‡æ›´é«˜ï¼‰
    const staticCacheKey = new Request(request.url, { method: 'GET' });

    let response;
    if (should_cache) {
      response = await cache.match(staticCacheKey);
    }

    // -----------------------------------------------------------
    // 9. å›æºï¼ˆåŒ…å«è¿›åº¦ä¸ŠæŠ¥èŠ‚æµå†™é” + é™æ€èµ„æºç¼“å­˜ï¼‰
    // -----------------------------------------------------------
    if (!response) {
      const new_request = new Request(url, {
        method: request.method,
        headers: new_headers,
        body: request.body,
        redirect: 'manual'
      });

      try {
        response = await fetch(new_request);

        // [ç­–ç•¥ A] Progressï¼šæ— è®ºæˆåŠŸå¤±è´¥éƒ½å†™å…¥ 3 ç§’é”ï¼›æºç«™é”™è¯¯åˆ™è¿”å› 204
        if (is_progress_report) {
          const dummyResponse = new Response('throttled', {
            headers: { 'Cache-Control': 'max-age=3' }
          });
          ctx.waitUntil(cache.put(lockKey, dummyResponse));

          if (response.status >= 400) {
            return new Response(null, { status: 204 });
          }
        }

        // [ç­–ç•¥ B] é™æ€èµ„æºç¼“å­˜ï¼šåªå…è®¸ GET å†™å…¥ï¼ˆHEAD æ²¡ bodyï¼‰
        if (request.method === 'GET' && should_cache && response.status === 200) {
          const response_to_cache = response.clone();
          const headers = new Headers(response_to_cache.headers);
          headers.set('Cache-Control', 'public, max-age=604800, immutable');

          const cachedResponse = new Response(response_to_cache.body, {
            status: response_to_cache.status,
            statusText: response_to_cache.statusText,
            headers
          });

          ctx.waitUntil(cache.put(staticCacheKey, cachedResponse));
        }
      } catch (err) {
        // [ç­–ç•¥ C] å›æºå¤±è´¥ï¼šProgress ä¹Ÿè¦å†™é”å¹¶å‡æˆåŠŸï¼Œé˜²æ­¢å®¢æˆ·ç«¯ç–¯ç‹‚é‡è¯•
        if (is_progress_report) {
          const dummyResponse = new Response('throttled', {
            headers: { 'Cache-Control': 'max-age=3' }
          });
          ctx.waitUntil(cache.put(lockKey, dummyResponse));
          return new Response(null, { status: 204 });
        }

        return new Response(`Upstream Error: ${err.message}`, { status: 502 });
      }
    }

    // -----------------------------------------------------------
    // 10. å“åº”å¤„ç†
    // -----------------------------------------------------------
    const response_headers = new Headers(response.headers);

    // é‡å†™ locationï¼ŒæŠŠä¸Šæ¸¸åŸŸåæ›¿æ¢å› worker åŸŸå
    if (response_headers.has('location')) {
      const location = response_headers.get('location');
      if (location && location.includes(upstream_domain)) {
        response_headers.set('location', location.replace(upstream_domain, worker_domain));
      }
    }

    response_headers.set('Access-Control-Allow-Origin', '*');
    response_headers.set('Access-Control-Expose-Headers', '*');

    return new Response(response.body, {
      status: response.status,
      statusText: response.statusText,
      headers: response_headers
    });
  }
};
```
</CodeBlock>
<img src={img3.src} alt="å›¾3" />
# ç¬¬ä¸‰æ­¥ï¼šä¼˜é€‰åŸŸå
ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªä¼˜è´¨çš„åŸŸåæ¥è®¿é—®æ‚¨çš„ Cloudflare Workerã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®ï¼š
## è·å–ä¼˜é€‰åŸŸå
- ä¼˜é€‰åŸŸåæŒ‡çš„æ˜¯è¿æ¥æ¯”è¾ƒå¿«çš„cloudflare CDNèŠ‚ç‚¹çš„åŸŸåï¼Œhttps://cf.090227.xyz/ ä¸Šé¢æ€»ç»“äº†å…¨çƒå¤šä¸ªåœ°åŒºè®¿é—® Cloudflare çš„ä¼˜é€‰åŸŸåï¼Œæ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„åœ°ç†ä½ç½®é€‰æ‹©ä¸€ä¸ªè®¿é—®é€Ÿåº¦è¾ƒå¿«çš„åŸŸåã€‚
## é…ç½® DNS è®°å½•
- ç™»å½•cloudflare è´¦æˆ·ï¼Œè¿›å…¥æ‚¨çš„åŸŸåç®¡ç†é¡µé¢ï¼Œæ‰¾åˆ° DNS è®¾ç½®ã€‚
- æ·»åŠ ä¸€ä¸ª CNAME è®°å½•ï¼Œå°†æ‚¨çš„å­åŸŸåæŒ‡å‘ Cloudflare æä¾›çš„ä¼˜é€‰åŸŸåã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨é€‰æ‹©çš„ä¼˜é€‰åŸŸåæ˜¯ `staticdelivery.nexusmods.com`ï¼Œå¹¶ä¸”æ‚¨çš„å­åŸŸåæ˜¯ `emby.yourdomain.com`ï¼Œåˆ™æ·»åŠ ä¸€æ¡ CNAME è®°å½•ï¼Œå°† `emby.yourdomain.com` æŒ‡å‘ `staticdelivery.nexusmods.com`ã€‚
<img src={img4.src} alt="å›¾4" />
## é…ç½® Cloudflare Workers è·¯ç”±
- å›åˆ° Cloudflare Workers é¡µé¢ï¼Œé€‰æ‹©æ‚¨çš„ Workerï¼Œç‚¹å‡»è®¾ç½®ã€‚
- æ·»åŠ ä¸€ä¸ªæ–°çš„è·¯ç”±ï¼Œè¾“å…¥æ‚¨åˆšæ‰é…ç½®çš„å­åŸŸåï¼ˆä¾‹å¦‚ `emby.yourdomain.com/*`ï¼‰ï¼Œå¹¶å°†å…¶æŒ‡å‘æ‚¨çš„ Workerã€‚
<img src={img5.src} alt="å›¾5" />
## æµ‹è¯•è®¿é—®
- ç­‰å¾… DNS è®°å½•ç”Ÿæ•ˆåï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¿é—®æ‚¨é…ç½®çš„å­åŸŸåæ¥æµ‹è¯•æ‚¨çš„ Worker æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚ä¾‹å¦‚ï¼Œè®¿é—® `https://emby.yourdomain.com` çœ‹é¡µé¢æ˜¯å¦æ­£å¸¸ï¼Œç„¶ååœ¨yambyç­‰å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ `https://emby.yourdomain.com` ä½œä¸ºæœåŠ¡å™¨åœ°å€æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿æ¥å’Œè®¿é—® emby æœåŠ¡ã€‚
é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å°±å¯ä»¥æˆåŠŸä½¿ç”¨ Cloudflare Workers å®ç° emby çš„åå‘ä»£ç†åŠŸèƒ½ï¼Œå¹¶é€šè¿‡ä¼˜é€‰åŸŸåè·å¾—æ›´å¥½çš„è®¿é—®æ€§èƒ½ã€‚å¦‚æœæ‚¨åœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ Cloudflare çš„å®˜æ–¹æ–‡æ¡£æˆ–ç¤¾åŒºè®ºå›è·å–æ›´å¤šå¸®åŠ©ã€‚